/**********************************************************************
 Copyright (c) 2020-2023, Unitree Robotics.Co.Ltd. All rights reserved.
***********************************************************************/
#ifndef FSMSTATE_H
#define FSMSTATE_H

// ==================== æ ‡å‡†åº“å¤´æ–‡ä»¶ ====================
#include <string>      // å­—ç¬¦ä¸²å¤„ç†
#include <iostream>    // è¾“å…¥è¾“å‡ºæµ
#include <unistd.h>    // Unixæ ‡å‡†å‡½æ•°å®šä¹‰

// ==================== ç³»ç»Ÿæ ¸å¿ƒç»„ä»¶ ====================
#include "control/CtrlComponents.h"  // æ§åˆ¶ç»„ä»¶é›†åˆ
#include "message/LowlevelCmd.h"     // åº•å±‚æ§åˆ¶å‘½ä»¤
#include "message/LowlevelState.h"   // åº•å±‚çŠ¶æ€åé¦ˆ

// ==================== é€šç”¨å·¥å…·å’Œç±»å‹ ====================
#include "common/enumClass.h"        // æšä¸¾ç±»å®šä¹‰
#include "common/mathTools.h"        // æ•°å­¦å·¥å…·å‡½æ•°
#include "common/mathTypes.h"        // æ•°å­¦ç±»å‹å®šä¹‰ï¼ˆå‘é‡ã€çŸ©é˜µç­‰ï¼‰
#include "common/timeMarker.h"       // æ—¶é—´æ ‡è®°å·¥å…·
#include "interface/CmdPanel.h"      // å‘½ä»¤é¢æ¿ï¼ˆç”¨æˆ·è¾“å…¥å¤„ç†ï¼‰

/**
* @brief æœ‰é™çŠ¶æ€æœºçŠ¶æ€æŠ½è±¡åŸºç±»
* 
* è¿™æ˜¯æ‰€æœ‰æœºå™¨äººè¡Œä¸ºçŠ¶æ€çš„åŸºç±»ï¼Œå®šä¹‰äº†çŠ¶æ€æœºçš„æ ‡å‡†æ¥å£ã€‚
* æ¯ä¸ªå…·ä½“çš„æœºå™¨äººè¡Œä¸ºï¼ˆå¦‚ç«™ç«‹ã€è¡Œèµ°ã€æµ‹è¯•ç­‰ï¼‰éƒ½éœ€è¦ç»§æ‰¿è¿™ä¸ªç±»ã€‚
* 
* è®¾è®¡ç†å¿µï¼š
* - æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼šå®šä¹‰çŠ¶æ€æ‰§è¡Œçš„æ ‡å‡†æµç¨‹
* - ç­–ç•¥æ¨¡å¼ï¼šæ¯ä¸ªçŠ¶æ€å°è£…ä¸€ç§ç‰¹å®šçš„è¡Œä¸ºç­–ç•¥
* - å¤šæ€æœºåˆ¶ï¼šé€šè¿‡è™šå‡½æ•°å®ç°ä¸åŒçŠ¶æ€çš„ç‰¹å®šè¡Œä¸º
* 
* çŠ¶æ€ç”Ÿå‘½å‘¨æœŸï¼š
* 1. enter()  - çŠ¶æ€åˆå§‹åŒ–ï¼šè®¾ç½®åˆå§‹å‚æ•°ã€é‡ç½®å˜é‡
* 2. run()    - çŠ¶æ€æ‰§è¡Œï¼šæ ¸å¿ƒæ§åˆ¶é€»è¾‘ï¼Œæ¯ä¸ªæ§åˆ¶å‘¨æœŸè°ƒç”¨
* 3. exit()   - çŠ¶æ€æ¸…ç†ï¼šä¿å­˜æ•°æ®ã€é‡Šæ”¾èµ„æºã€æ¸…ç†å·¥ä½œ
* 4. checkChange() - è½¬æ¢æ£€æŸ¥ï¼šåˆ¤æ–­æ˜¯å¦éœ€è¦åˆ‡æ¢åˆ°å…¶ä»–çŠ¶æ€
*/
class FSMState{
public:
    /**
    * @brief æ„é€ å‡½æ•°
    * @param ctrlComp æ§åˆ¶ç»„ä»¶æŒ‡é’ˆï¼Œæä¾›å¯¹æ•´ä¸ªæ§åˆ¶ç³»ç»Ÿçš„è®¿é—®
    * @param stateName çŠ¶æ€åæšä¸¾å€¼ï¼Œç”¨äºçŠ¶æ€è¯†åˆ«å’Œè½¬æ¢
    * @param stateNameString çŠ¶æ€åå­—ç¬¦ä¸²ï¼Œç”¨äºè°ƒè¯•å’Œæ—¥å¿—è¾“å‡º
    * 
    * æ„é€ å‡½æ•°è´Ÿè´£ï¼š
    * 1. ä¿å­˜æ§åˆ¶ç»„ä»¶å¼•ç”¨ï¼Œè®©çŠ¶æ€å¯ä»¥è®¿é—®æ‰€æœ‰ç³»ç»Ÿèµ„æº
    * 2. è®¾ç½®çŠ¶æ€æ ‡è¯†ï¼Œä¾¿äºçŠ¶æ€æœºç®¡ç†
    * 3. åˆå§‹åŒ–å¿«æ·è®¿é—®æŒ‡é’ˆï¼Œæé«˜è¿è¡Œæ•ˆç‡
    */
    FSMState(CtrlComponents *ctrlComp, FSMStateName stateName, std::string stateNameString);

    // ==================== çº¯è™šå‡½æ•°æ¥å£ ====================
    // è¿™äº›å‡½æ•°å¿…é¡»è¢«æ‰€æœ‰å­ç±»å®ç°ï¼Œå®šä¹‰äº†çŠ¶æ€çš„æ ‡å‡†è¡Œä¸º
    
    /**
    * @brief è¿›å…¥çŠ¶æ€æ—¶çš„åˆå§‹åŒ–å‡½æ•° [çº¯è™šå‡½æ•°]
    * 
    * å½“çŠ¶æ€æœºåˆ‡æ¢åˆ°è¿™ä¸ªçŠ¶æ€æ—¶è°ƒç”¨ï¼Œè´Ÿè´£ï¼š
    * - åˆå§‹åŒ–çŠ¶æ€ç›¸å…³çš„å˜é‡å’Œå‚æ•°
    * - è®¾ç½®æ§åˆ¶å™¨çš„åˆå§‹é…ç½®ï¼ˆå¢ç›Šã€æ¨¡å¼ç­‰ï¼‰
    * - è®°å½•è¿›å…¥çŠ¶æ€æ—¶çš„æœºå™¨äººçŠ¶æ€
    * - å‡†å¤‡çŠ¶æ€æ‰§è¡Œæ‰€éœ€çš„èµ„æº
    * 
    * è°ƒç”¨æ—¶æœºï¼šçŠ¶æ€è½¬æ¢çš„ç¬¬ä¸€æ­¥
    * è°ƒç”¨é¢‘ç‡ï¼šæ¯æ¬¡è¿›å…¥çŠ¶æ€æ—¶è°ƒç”¨ä¸€æ¬¡
    */
    virtual void enter() = 0;
    
    /**
    * @brief çŠ¶æ€ä¸»æ‰§è¡Œå‡½æ•° [çº¯è™šå‡½æ•°]
    * 
    * çŠ¶æ€çš„æ ¸å¿ƒå‡½æ•°ï¼ŒåŒ…å«è¯¥çŠ¶æ€çš„ä¸»è¦æ§åˆ¶é€»è¾‘ï¼š
    * - è¯»å–ä¼ æ„Ÿå™¨æ•°æ®å’Œç”¨æˆ·è¾“å…¥
    * - æ‰§è¡ŒçŠ¶æ€ç‰¹å®šçš„æ§åˆ¶ç®—æ³•
    * - è®¡ç®—å¹¶è®¾ç½®æœºå™¨äººæ§åˆ¶å‘½ä»¤
    * - æ›´æ–°çŠ¶æ€å†…éƒ¨å˜é‡
    * 
    * è°ƒç”¨æ—¶æœºï¼šçŠ¶æ€æ­£å¸¸è¿è¡ŒæœŸé—´
    * è°ƒç”¨é¢‘ç‡ï¼šæ¯ä¸ªæ§åˆ¶å‘¨æœŸï¼ˆ500Hzï¼‰è°ƒç”¨ä¸€æ¬¡
    * 
    * å…¸å‹å®ç°æµç¨‹ï¼š
    * 1. è·å–ç”¨æˆ·å‘½ä»¤å’Œä¼ æ„Ÿå™¨æ•°æ®
    * 2. æ‰§è¡ŒçŠ¶æ€ç‰¹å®šçš„æ§åˆ¶ç®—æ³•
    * 3. è®¡ç®—å…³èŠ‚æ§åˆ¶å‘½ä»¤
    * 4. è®¾ç½®è¾“å‡ºå‘½ä»¤
    */
    virtual void run() = 0;
    
    /**
    * @brief é€€å‡ºçŠ¶æ€æ—¶çš„æ¸…ç†å‡½æ•° [çº¯è™šå‡½æ•°]
    * 
    * å½“çŠ¶æ€æœºå‡†å¤‡ç¦»å¼€è¿™ä¸ªçŠ¶æ€æ—¶è°ƒç”¨ï¼Œè´Ÿè´£ï¼š
    * - ä¿å­˜é‡è¦çš„çŠ¶æ€ä¿¡æ¯
    * - æ¸…ç†ä¸´æ—¶èµ„æºå’Œå˜é‡
    * - ä¸ºä¸‹ä¸€ä¸ªçŠ¶æ€åšå‡†å¤‡
    * - æ‰§è¡Œå®‰å…¨æ€§æ£€æŸ¥å’Œè®¾ç½®
    * 
    * è°ƒç”¨æ—¶æœºï¼šçŠ¶æ€è½¬æ¢è¿‡ç¨‹ä¸­ï¼Œè¿›å…¥æ–°çŠ¶æ€ä¹‹å‰
    * è°ƒç”¨é¢‘ç‡ï¼šæ¯æ¬¡ç¦»å¼€çŠ¶æ€æ—¶è°ƒç”¨ä¸€æ¬¡
    */
    virtual void exit() = 0;
    
    /**
    * @brief æ£€æŸ¥çŠ¶æ€è½¬æ¢æ¡ä»¶ [è™šå‡½æ•°ï¼Œå¯é‡å†™]
    * @return ä¸‹ä¸€ä¸ªç›®æ ‡çŠ¶æ€çš„æšä¸¾å€¼
    * 
    * æ£€æŸ¥æ˜¯å¦æ»¡è¶³çŠ¶æ€è½¬æ¢çš„æ¡ä»¶ï¼š
    * - åˆ†æç”¨æˆ·è¾“å…¥å‘½ä»¤
    * - æ£€æŸ¥å®‰å…¨æ¡ä»¶
    * - è¯„ä¼°ä»»åŠ¡å®Œæˆæƒ…å†µ
    * - åˆ¤æ–­å¼‚å¸¸æƒ…å†µ
    * 
    * è°ƒç”¨æ—¶æœºï¼šæ¯ä¸ªæ§åˆ¶å‘¨æœŸçš„çŠ¶æ€æ‰§è¡Œå
    * è°ƒç”¨é¢‘ç‡ï¼šæ¯ä¸ªæ§åˆ¶å‘¨æœŸï¼ˆ500Hzï¼‰è°ƒç”¨ä¸€æ¬¡
    * 
    * è¿”å›å€¼è¯´æ˜ï¼š
    * - è¿”å›å½“å‰çŠ¶æ€åï¼šç»§ç»­ä¿æŒå½“å‰çŠ¶æ€
    * - è¿”å›å…¶ä»–çŠ¶æ€åï¼šè¯·æ±‚åˆ‡æ¢åˆ°è¯¥çŠ¶æ€
    * - è¿”å›INVALIDï¼šå¼‚å¸¸æƒ…å†µæˆ–é”™è¯¯
    * 
    * é»˜è®¤å®ç°ï¼šè¿”å›INVALIDï¼Œå­ç±»åº”è¯¥é‡å†™æ­¤å‡½æ•°
    */
    virtual FSMStateName checkChange() {return FSMStateName::INVALID;}

    // ==================== å…¬å…±æˆå‘˜å˜é‡ ====================
    
    /**
    * @brief çŠ¶æ€åæšä¸¾
    * ç”¨äºçŠ¶æ€æœºå†…éƒ¨çš„çŠ¶æ€è¯†åˆ«å’Œè½¬æ¢åˆ¤æ–­
    * ä¾‹å¦‚ï¼šFSMStateName::PASSIVE, FSMStateName::TROTTING
    */
    FSMStateName _stateName;
    
    /**
    * @brief çŠ¶æ€åå­—ç¬¦ä¸²
    * ç”¨äºè°ƒè¯•è¾“å‡ºã€æ—¥å¿—è®°å½•å’Œç”¨æˆ·ç•Œé¢æ˜¾ç¤º
    * ä¾‹å¦‚ï¼š"passive", "trotting", "fixed stand"
    */
    std::string _stateNameString;

protected:
    // ==================== å—ä¿æŠ¤æˆå‘˜å˜é‡ ====================
    // è¿™äº›å˜é‡åªèƒ½è¢«å­ç±»è®¿é—®ï¼Œæä¾›äº†çŠ¶æ€å®ç°æ‰€éœ€çš„åŸºç¡€èµ„æº
    
    /**
    * @brief æ§åˆ¶ç»„ä»¶æŒ‡é’ˆ
    * æä¾›å¯¹æ•´ä¸ªæ§åˆ¶ç³»ç»Ÿçš„è®¿é—®ï¼ŒåŒ…æ‹¬ï¼š
    * - æœºå™¨äººæ¨¡å‹å’Œå‚æ•°
    * - æ­¥æ€ç”Ÿæˆå™¨
    * - çŠ¶æ€ä¼°è®¡å™¨
    * - å¹³è¡¡æ§åˆ¶å™¨
    * - IOé€šä¿¡æ¥å£
    * - æ‰€æœ‰ä¼ æ„Ÿå™¨æ•°æ®å’Œæ§åˆ¶å‘½ä»¤
    */
    CtrlComponents *_ctrlComp;
    
    /**
    * @brief ä¸‹ä¸€ä¸ªçŠ¶æ€å
    * ä¸´æ—¶å˜é‡ï¼Œç”¨äºå­˜å‚¨çŠ¶æ€è½¬æ¢çš„ç›®æ ‡çŠ¶æ€
    * åœ¨checkChange()å‡½æ•°ä¸­è®¾ç½®ï¼Œç”±çŠ¶æ€æœºä½¿ç”¨
    */
    FSMStateName _nextStateName;

    // ==================== å¿«æ·è®¿é—®æŒ‡é’ˆ ====================
    // ä¸ºäº†æé«˜è®¿é—®æ•ˆç‡ï¼Œç›´æ¥ä¿å­˜å¸¸ç”¨æ•°æ®çš„æŒ‡é’ˆ
    
    /**
    * @brief åº•å±‚æ§åˆ¶å‘½ä»¤æŒ‡é’ˆ
    * ç›´æ¥æŒ‡å‘æ§åˆ¶ç»„ä»¶ä¸­çš„lowCmdï¼Œæ–¹ä¾¿å¿«é€Ÿè®¿é—®
    * ç”¨äºè®¾ç½®ï¼š
    * - 12ä¸ªå…³èŠ‚çš„ç›®æ ‡ä½ç½®ã€é€Ÿåº¦ã€åŠ›çŸ©
    * - æ§åˆ¶å¢ç›Šå‚æ•°ï¼ˆKp, Kdï¼‰
    * - æ§åˆ¶æ¨¡å¼é€‰æ‹©
    */
    LowlevelCmd *_lowCmd;
    
    /**
    * @brief åº•å±‚çŠ¶æ€åé¦ˆæŒ‡é’ˆ
    * ç›´æ¥æŒ‡å‘æ§åˆ¶ç»„ä»¶ä¸­çš„lowStateï¼Œæ–¹ä¾¿å¿«é€Ÿè®¿é—®
    * ç”¨äºè¯»å–ï¼š
    * - 12ä¸ªå…³èŠ‚çš„å®é™…ä½ç½®ã€é€Ÿåº¦ã€åŠ›çŸ©
    * - IMUæ•°æ®ï¼ˆå§¿æ€ã€è§’é€Ÿåº¦ã€åŠ é€Ÿåº¦ï¼‰
    * - ç”¨æˆ·è¾“å…¥å‘½ä»¤
    * - è¶³ç«¯æ¥è§¦ä¿¡æ¯
    */
    LowlevelState *_lowState;
    
    /**
    * @brief ç”¨æˆ·æ•°å€¼è¾“å…¥
    * å­˜å‚¨ç”¨æˆ·é€šè¿‡æ“ä½œç•Œé¢è¾“å…¥çš„æ•°å€¼å‚æ•°
    * å¯èƒ½åŒ…å«ï¼š
    * - è¿åŠ¨é€Ÿåº¦è®¾å®šå€¼
    * - å§¿æ€è°ƒæ•´å‚æ•°
    * - æµ‹è¯•å‚æ•°ç­‰
    */
    UserValue _userValue;
};

#endif  // FSMSTATE_H

/*
* ==================== è®¾è®¡æ¨¡å¼åˆ†æ ====================
* 
* ## ğŸ¨ æ¨¡æ¿æ–¹æ³•æ¨¡å¼ (Template Method Pattern)
* 
* FSMStateå®šä¹‰äº†çŠ¶æ€æ‰§è¡Œçš„æ ‡å‡†æ¨¡æ¿ï¼š
* ```
* çŠ¶æ€è½¬æ¢æµç¨‹ï¼š
* 1. currentState->exit()    // é€€å‡ºå½“å‰çŠ¶æ€
* 2. currentState = newState // åˆ‡æ¢çŠ¶æ€æŒ‡é’ˆ  
* 3. currentState->enter()   // è¿›å…¥æ–°çŠ¶æ€
* 
* çŠ¶æ€è¿è¡Œæµç¨‹ï¼š
* 1. currentState->run()        // æ‰§è¡ŒçŠ¶æ€é€»è¾‘
* 2. currentState->checkChange() // æ£€æŸ¥è½¬æ¢æ¡ä»¶
* ```
* 
* ## ğŸ¯ ç­–ç•¥æ¨¡å¼ (Strategy Pattern)
* 
* æ¯ä¸ªå…·ä½“çŠ¶æ€ç±»å®ç°ä¸åŒçš„è¡Œä¸ºç­–ç•¥ï¼š
* - State_Passive: è¢«åŠ¨ç­–ç•¥ï¼ˆå…³èŠ‚æ¾å¼›ï¼‰
* - State_FixedStand: å›ºå®šç«™ç«‹ç­–ç•¥ï¼ˆä½ç½®æ§åˆ¶ï¼‰
* - State_Trotting: åŠ¨æ€è¡Œèµ°ç­–ç•¥ï¼ˆæ­¥æ€æ§åˆ¶ï¼‰
* - State_BalanceTest: å¹³è¡¡æµ‹è¯•ç­–ç•¥ï¼ˆåŠ›æ§åˆ¶ï¼‰
* 
* ## ğŸ”— å¤šæ€æœºåˆ¶ (Polymorphism)
* 
* é€šè¿‡è™šå‡½æ•°å®ç°è¿è¡Œæ—¶å¤šæ€ï¼š
* ```cpp
* FSMState *currentState = new State_Trotting(ctrlComp);
* currentState->run();  // è°ƒç”¨State_Trotting::run()
* ```
* 
* ==================== å†…å­˜ç®¡ç†ç­–ç•¥ ====================
* 
* ## ğŸ“¦ å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ
* 
* 1. **åˆ›å»ºé˜¶æ®µ**ï¼š
*    - æ‰€æœ‰çŠ¶æ€å¯¹è±¡åœ¨FSMæ„é€ æ—¶åˆ›å»º
*    - å¯¹è±¡åœ¨æ•´ä¸ªç¨‹åºè¿è¡ŒæœŸé—´å¸¸é©»å†…å­˜
*    - é¿å…è¿è¡Œæ—¶çš„åŠ¨æ€åˆ†é…å¼€é”€
* 
* 2. **è¿è¡Œé˜¶æ®µ**ï¼š
*    - çŠ¶æ€åˆ‡æ¢åªæ˜¯æŒ‡é’ˆæ“ä½œï¼Œæ— å†…å­˜åˆ†é…
*    - é€šè¿‡enter()/exit()ç®¡ç†çŠ¶æ€èµ„æº
*    - é«˜æ•ˆçš„å®æ—¶æ€§èƒ½
* 
* 3. **é”€æ¯é˜¶æ®µ**ï¼š
*    - FSMææ„æ—¶ç»Ÿä¸€æ¸…ç†æ‰€æœ‰çŠ¶æ€å¯¹è±¡
*    - é˜²æ­¢å†…å­˜æ³„éœ²
* 
* ## ğŸš€ æ€§èƒ½ä¼˜åŒ–ç‰¹ç‚¹
* 
* 1. **å¿«æ·æŒ‡é’ˆ**ï¼š
*    ```cpp
*    _lowCmd = _ctrlComp->lowCmd;    // é¿å…å¤šå±‚è§£å¼•ç”¨
*    _lowState = _ctrlComp->lowState; // æé«˜è®¿é—®æ•ˆç‡
*    ```
* 
* 2. **å¯¹è±¡å¤ç”¨**ï¼š
*    - çŠ¶æ€å¯¹è±¡åˆ›å»ºä¸€æ¬¡ï¼Œä½¿ç”¨æ•´ä¸ªç”Ÿå‘½å‘¨æœŸ
*    - çŠ¶æ€åˆ‡æ¢æ— å†…å­˜åˆ†é…å¼€é”€
*    - é€‚åˆ500Hzé«˜é¢‘å®æ—¶æ§åˆ¶
* 
* 3. **æ¥å£ç®€åŒ–**ï¼š
*    - å››ä¸ªæ ¸å¿ƒå‡½æ•°è¦†ç›–æ‰€æœ‰çŠ¶æ€è¡Œä¸º
*    - æ¸…æ™°çš„èŒè´£åˆ†ç¦»
*    - ä¾¿äºç†è§£å’Œå®ç°
* 
* ==================== æ‰©å±•æ€§è®¾è®¡ ====================
* 
* ## â• æ·»åŠ æ–°çŠ¶æ€çš„æ­¥éª¤
* 
* 1. **åˆ›å»ºçŠ¶æ€ç±»**ï¼š
*    ```cpp
*    class State_NewBehavior : public FSMState {
*    public:
*        State_NewBehavior(CtrlComponents *ctrlComp);
*        void enter() override;
*        void run() override;
*        void exit() override;
*        FSMStateName checkChange() override;
*    };
*    ```
* 
* 2. **æ·»åŠ çŠ¶æ€æšä¸¾**ï¼š
*    ```cpp
*    enum class FSMStateName {
*        // ... ç°æœ‰çŠ¶æ€
*        NEWBEHAVIOR,  // æ–°çŠ¶æ€
*    };
*    ```
* 
* 3. **æ›´æ–°çŠ¶æ€åˆ—è¡¨**ï¼š
*    ```cpp
*    struct FSMStateList {
*        // ... ç°æœ‰çŠ¶æ€æŒ‡é’ˆ
*        State_NewBehavior *newBehavior;
*    };
*    ```
* 
* 4. **æ›´æ–°çŠ¶æ€æœº**ï¼š
*    - åœ¨FSMæ„é€ å‡½æ•°ä¸­åˆ›å»ºçŠ¶æ€å¯¹è±¡
*    - åœ¨getNextState()ä¸­æ·»åŠ æ˜ å°„
*    - åœ¨deletePtr()ä¸­æ·»åŠ æ¸…ç†ä»£ç 
* 
* ## ğŸ”§ è‡ªå®šä¹‰æ§åˆ¶é€»è¾‘
* 
* æ¯ä¸ªçŠ¶æ€å¯ä»¥ï¼š
* - å®ç°ç‹¬ç‰¹çš„æ§åˆ¶ç®—æ³•
* - ä½¿ç”¨ä¸åŒçš„ä¼ æ„Ÿå™¨æ•°æ®
* - è®¾ç½®ç‰¹å®šçš„æ§åˆ¶å‚æ•°
* - å®šä¹‰ä¸“é—¨çš„è½¬æ¢æ¡ä»¶
* 
* è¿™ç§è®¾è®¡ä½¿å¾—ç³»ç»Ÿå…·æœ‰æå¼ºçš„æ‰©å±•èƒ½åŠ›ï¼
*/