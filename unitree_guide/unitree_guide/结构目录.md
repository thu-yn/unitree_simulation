# unitree_guide/unitree_guide 文件夹详细结构

## 📁 总体目录结构
```
unitree_guide/unitree_guide/
├── 📁 include/                         # 头文件目录
│   ├── 📁 FSM/                         # 有限状态机模块
│   ├── 📁 control/                     # 控制组件模块
│   ├── 📁 Gait/                        # 步态生成模块
│   ├── 📁 interface/                   # 接口模块
│   ├── 📁 message/                     # 消息定义模块
│   └── 📁 common/                      # 通用工具模块
├── 📁 src/                             # 源代码目录
│   ├── 📁 FSM/                         # 状态机实现源码
│   ├── 📁 control/                     # 控制组件实现源码
│   ├── 📁 Gait/                        # 步态生成实现源码
│   ├── 📁 interface/                   # 接口实现源码
│   ├── 📁 message/                     # 消息实现源码
│   ├── 📁 common/                      # 通用工具实现源码
│   └── 📄 main.cpp                     # 主程序入口
├── 📁 library/                         # 依赖库目录
│   ├── 📁 unitree_legged_sdk_3.2/      # SDK版本3.2
│   ├── 📁 unitree_legged_sdk_3.4/      # SDK版本3.4
│   └── 📁 unitree_legged_sdk-3.8.0/    # SDK版本3.8
├── 📁 launch/                          # ROS启动文件
├── 📄 CMakeLists.txt                   # CMake构建配置
└── 📄 package.xml                      # ROS包配置文件
```

## 📂 1. include/ 目录详细结构

### 🔧 FSM/ (有限状态机)
```
include/FSM/
├── 📄 FSM.h                           # 状态机主控制器
├── 📄 FSMState.h                      # 状态基类定义
├── 📄 State_Passive.h                 # 被动状态（初始状态）
├── 📄 State_FixedStand.h              # 固定站立状态
├── 📄 State_FreeStand.h               # 自由站立状态
├── 📄 State_Trotting.h                # 小跑步态状态
├── 📄 State_BalanceTest.h             # 平衡测试状态
├── 📄 State_SwingTest.h               # 摆动测试状态
├── 📄 State_StepTest.h                # 步伐测试状态
└── 📄 State_move_base.h               # 移动基座状态（可选编译）
```

**核心状态类型说明**：
- `PASSIVE` → `FIXEDSTAND` → `TROTTING` 为主要控制流程
- 按键控制：'2'键进入站立，'4'键进入小跑，'wasd'控制移动

### ⚙️ control/ (控制组件)
```
include/control/
├── 📄 CtrlComponents.h                # 控制组件集合（核心）
├── 📄 ControlFrame.h                  # 主控制框架
├── 📄 Estimator.h                     # 状态估计器
├── 📄 BalanceCtrl.h                   # 平衡控制器
└── 📄 DataReader.h                    # 数据读取器
```

**CtrlComponents结构**：
```cpp
struct CtrlComponents {
    LowlevelCmd *lowCmd;           // 底层命令
    LowlevelState *lowState;       // 底层状态
    IOInterface *ioInter;          // IO接口
    QuadrupedRobot *robotModel;    // 机器人模型
    WaveGenerator *waveGen;        // 波形生成器
    Estimator *estimator;          // 状态估计器
    BalanceCtrl *balCtrl;          // 平衡控制器
    VecInt4 *contact;              // 足端接触状态
    Vec4 *phase;                   // 步态相位
    double dt = 0.002;             // 控制周期(500Hz)
};
```

### 🚶 Gait/ (步态生成)
```
include/Gait/
├── 📄 WaveGenerator.h                 # 波形生成器
├── 📄 GaitGenerator.h                 # 步态生成器
└── 📄 Bezier.h                        # 贝塞尔曲线工具
```

**预设步态参数**：
```cpp
// 小跑步态 (默认)
WaveGenerator(0.45, 0.5, Vec4(0, 0.5, 0.5, 0));
// 爬行步态
WaveGenerator(1.1, 0.75, Vec4(0, 0.25, 0.5, 0.75));
// 跳跃步态
WaveGenerator(0.4, 0.7, Vec4(0, 0, 0, 0));
```

### 🔌 interface/ (接口模块)
```
include/interface/
├── 📄 IOInterface.h                   # 抽象IO接口基类
├── 📄 IOROS.h                         # ROS/Gazebo仿真接口
├── 📄 IOSDK.h                         # 真实机器人SDK接口
├── 📄 CmdPanel.h                      # 命令面板
└── 📄 KeyBoard.h                      # 键盘输入处理
```

**接口层次结构**：
```
IOInterface (基类)
├── IOROS     (仿真环境接口)
└── IOSDK     (真实机器人接口)
```

### 📨 message/ (消息定义)
```
include/message/
├── 📄 LowlevelCmd.h                   # 底层控制命令
├── 📄 LowlevelState.h                 # 底层状态反馈
└── 📄 unitree_joystick.h              # 手柄消息定义
```

### 🛠️ common/ (通用工具)
```
include/common/
├── 📄 enumClass.h                     # 枚举类定义
├── 📄 mathTypes.h                     # 数学类型定义
├── 📄 mathTools.h                     # 数学工具函数
├── 📄 timeMarker.h                    # 时间标记工具
├── 📄 unitreeRobot.h                  # 机器人模型定义
├── 📄 filter.h                        # 滤波器工具
└── 📄 PyPlot.h                        # Python绘图接口（调试用）
```

## 📂 2. src/ 目录详细结构

### 状态机实现
```
src/FSM/
├── 📄 FSM.cpp                         # 状态机主控制器实现
├── 📄 FSMState.cpp                    # 状态基类实现
├── 📄 State_Passive.cpp               # 被动状态实现
├── 📄 State_FixedStand.cpp            # 固定站立实现
├── 📄 State_FreeStand.cpp             # 自由站立实现
├── 📄 State_Trotting.cpp              # 小跑步态实现
├── 📄 State_BalanceTest.cpp           # 平衡测试实现
├── 📄 State_SwingTest.cpp             # 摆动测试实现
├── 📄 State_StepTest.cpp              # 步伐测试实现
└── 📄 State_move_base.cpp             # 移动基座实现
```

### 控制组件实现
```
src/control/
├── 📄 ControlFrame.cpp                # 主控制框架实现
├── 📄 Estimator.cpp                   # 状态估计器实现
├── 📄 BalanceCtrl.cpp                 # 平衡控制器实现
└── 📄 DataReader.cpp                  # 数据读取器实现
```

### 步态生成实现
```
src/Gait/
├── 📄 WaveGenerator.cpp               # 波形生成器实现
├── 📄 GaitGenerator.cpp               # 步态生成器实现
└── 📄 Bezier.cpp                      # 贝塞尔曲线实现
```

### 接口实现
```
src/interface/
├── 📄 IOROS.cpp                       # ROS接口实现
├── 📄 IOSDK.cpp                       # SDK接口实现
├── 📄 CmdPanel.cpp                    # 命令面板实现
└── 📄 KeyBoard.cpp                    # 键盘输入实现
```

### 消息实现
```
src/message/
├── 📄 LowlevelCmd.cpp                 # 底层命令实现
└── 📄 LowlevelState.cpp               # 底层状态实现
```

### 通用工具实现
```
src/common/
├── 📄 mathTools.cpp                   # 数学工具实现
├── 📄 timeMarker.cpp                  # 时间标记实现
├── 📄 unitreeRobot.cpp                # 机器人模型实现
├── 📄 filter.cpp                      # 滤波器实现
└── 📄 PyPlot.cpp                      # Python绘图实现
```

### 🎯 主程序
```
src/
└── 📄 main.cpp                        # 主程序入口文件
```

**main.cpp 主要流程**：
```cpp
1. 设置实时进程调度 (SCHED_FIFO)
2. 初始化ROS节点 (如果启用)
3. 创建IO接口 (IOROS/IOSDK)
4. 初始化控制组件 (CtrlComponents)
5. 配置机器人模型 (A1/Go1)
6. 设置步态生成器 (默认Trot步态)
7. 创建控制框架 (ControlFrame)
8. 500Hz控制循环
```

## 📂 3. library/ 目录结构

### SDK版本管理
```
library/
├── 📁 unitree_legged_sdk_3.2/         # SDK版本3.2
│   ├── 📁 include/
│   │   └── 📁 unitree_legged_sdk/
│   │       ├── 📄 unitree_legged_sdk.h
│   │       ├── 📄 comm.h
│   │       ├── 📄 safety.h
│   │       ├── 📄 udp.h
│   │       └── 📄 loop.h
│   └── 📁 lib/
├── 📁 unitree_legged_sdk_3.4/         # SDK版本3.4
│   └── (类似结构)
└── 📁 unitree_legged_sdk-3.8.0/       # SDK版本3.8 (最新)
    ├── 📁 include/
    └── 📁 lib/
        ├── 📁 cpp/
        │   ├── 📁 amd64/
        │   └── 📁 arm64/
        └── 📁 python/
```

## 📂 4. launch/ 目录结构

```
launch/
├── 📄 gazeboSim.launch                # Gazebo仿真启动
├── 📄 realRobot.launch                # 真实机器人启动
└── 📄 debug.launch                    # 调试模式启动
```

## 📄 5. 配置文件

### CMakeLists.txt 关键配置
```cmake
# 编译选项控制
option(COMPILE_WITH_REAL_ROBOT "Compile with real robot" OFF)
option(COMPILE_WITH_ROS "Compile with ROS" ON)
option(COMPILE_WITH_MOVE_BASE "Compile with move_base" OFF)
option(COMPILE_DEBUG "Compile with debug" OFF)

# 机器人类型支持
option(ROBOT_TYPE_A1 "Robot type A1" OFF)
option(ROBOT_TYPE_Go1 "Robot type Go1" ON)
```

### package.xml 依赖关系
```xml
<depend>unitree_legged_msgs</depend>         <!-- 核心消息依赖 -->
<build_depend>controller_manager</build_depend>
<build_depend>joint_state_controller</build_depend>
<build_depend>robot_state_publisher</build_depend>
<build_depend>roscpp</build_depend>
<build_depend>std_msgs</build_depend>
```

## 🔗 6. 模块间耦合关系

### 强依赖关系
- **FSM模块** ↔ **control模块**: 状态机依赖控制组件
- **control模块** ↔ **interface模块**: 控制需要IO接口
- **Gait模块** ↔ **control模块**: 步态生成被控制框架使用

### 编译时依赖
```
main.cpp 
  ↓ includes
ControlFrame.h
  ↓ includes  
CtrlComponents.h + FSM.h
  ↓ includes
所有子模块头文件
```

## 🎮 7. 运行时行为

### 控制频率
- **主控制循环**: 500Hz (dt = 0.002s)
- **FSM状态检查**: 每个控制周期
- **步态生成**: 连续相位更新

### 状态转换流程
```
启动 → PASSIVE → FIXEDSTAND → TROTTING → 运动控制
  ↑                                         ↓
  ← ← ← ← ← ← ← ← ← ← ← ← ← ← ← ← ← ← ← ← ←
```

### 数据流向
```
用户输入 → CmdPanel → FSM → CtrlComponents → IOInterface → 机器人
                                                  ↓
传感器数据 ← LowlevelState ← IOInterface ← ← ← ← ←
```

## 💡 关键设计特点

1. **模块化设计**: 清晰的功能分离和接口定义
2. **多版本SDK支持**: 向后兼容不同SDK版本
3. **多平台支持**: 仿真环境和真实机器人统一接口
4. **实时控制**: 硬实时调度和高频控制循环
5. **状态机架构**: 清晰的行为状态管理
6. **步态算法**: 成熟的摆线轨迹生成

这个文件结构体现了一个成熟的四足机器人控制框架的设计思路，为理解和扩展该系统提供了清晰的模块组织。